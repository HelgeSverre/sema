{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Sema",
  "scopeName": "source.sema",
  "patterns": [
    { "include": "#comment" },
    { "include": "#string" },
    { "include": "#quoted-expression" },
    { "include": "#definition" },
    { "include": "#special-form" },
    { "include": "#threading-macro" },
    { "include": "#builtin" },
    { "include": "#operator" },
    { "include": "#keyword-literal" },
    { "include": "#character" },
    { "include": "#boolean" },
    { "include": "#nil" },
    { "include": "#number" },
    { "include": "#paren" }
  ],
  "repository": {
    "comment": {
      "name": "comment.line.semicolon.sema",
      "match": ";.*$"
    },
    "string": {
      "name": "string.quoted.double.sema",
      "begin": "\"",
      "end": "\"",
      "patterns": [
        {
          "name": "constant.character.escape.sema",
          "match": "\\\\(?:[\\\\\"nrt0]|x[0-9a-fA-F]+;|u[0-9a-fA-F]{4}|U[0-9a-fA-F]{8})"
        }
      ]
    },
    "keyword-literal": {
      "name": "constant.other.keyword.sema",
      "match": "(?<=[(\\[\\s,{]):[\\w!$%&*+\\-./:<=>?@^~][\\w!$%&*+\\-./:<=>?@^~0-9]*|^:[\\w!$%&*+\\-./:<=>?@^~][\\w!$%&*+\\-./:<=>?@^~0-9]*"
    },
    "character": {
      "patterns": [
        {
          "name": "constant.character.named.sema",
          "match": "(?<=[\\s(\\[{])#\\\\(?:space|newline|tab|return|nul|alarm|backspace|delete|escape)(?=[\\s)\\]}]|$)|^#\\\\(?:space|newline|tab|return|nul|alarm|backspace|delete|escape)(?=[\\s)\\]}]|$)"
        },
        {
          "name": "constant.character.sema",
          "match": "(?<=[\\s(\\[{])#\\\\.(?=[\\s)\\]}]|$)|^#\\\\.(?=[\\s)\\]}]|$)"
        }
      ]
    },
    "boolean": {
      "name": "constant.language.boolean.sema",
      "match": "(?<=[\\s(\\[{])(?:#t|#f|true|false)(?=[\\s)\\]}]|$)|^(?:#t|#f|true|false)(?=[\\s)\\]}]|$)"
    },
    "nil": {
      "name": "constant.language.nil.sema",
      "match": "(?<=[\\s(\\[{])nil(?=[\\s)\\]}]|$)|^nil(?=[\\s)\\]}]|$)"
    },
    "number": {
      "name": "constant.numeric.sema",
      "match": "(?<=[\\s(\\[{])-?(?:0[xX][0-9a-fA-F]+|0[bB][01]+|0[oO][0-7]+|[0-9]+(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?)(?=[\\s)\\]}]|$)|^-?(?:0[xX][0-9a-fA-F]+|0[bB][01]+|0[oO][0-7]+|[0-9]+(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?)(?=[\\s)\\]}]|$)"
    },
    "definition": {
      "patterns": [
        {
          "comment": "define with a simple name: (define name ...)",
          "match": "(\\()\\s*(define)\\s+([\\w!$%&*+\\-./:<=>?@^~][\\w!$%&*+\\-./:<=>?@^~0-9]*)",
          "captures": {
            "1": { "name": "punctuation.paren.open.sema" },
            "2": { "name": "keyword.control.definition.sema" },
            "3": { "name": "entity.name.function.sema" }
          }
        },
        {
          "comment": "define with parens: (define (name args...) ...)",
          "match": "(\\()\\s*(define)\\s+(\\()\\s*([\\w!$%&*+\\-./:<=>?@^~][\\w!$%&*+\\-./:<=>?@^~0-9]*)",
          "captures": {
            "1": { "name": "punctuation.paren.open.sema" },
            "2": { "name": "keyword.control.definition.sema" },
            "3": { "name": "punctuation.paren.open.sema" },
            "4": { "name": "entity.name.function.sema" }
          }
        },
        {
          "comment": "defun/defmacro/defagent/deftool name",
          "match": "(\\()\\s*(defun|defmacro|defagent|deftool|define-record-type)\\s+([\\w!$%&*+\\-./:<=>?@^~][\\w!$%&*+\\-./:<=>?@^~0-9]*)",
          "captures": {
            "1": { "name": "punctuation.paren.open.sema" },
            "2": { "name": "keyword.control.definition.sema" },
            "3": { "name": "entity.name.function.sema" }
          }
        }
      ]
    },
    "special-form": {
      "match": "(?<=[\\s(\\[{])(?:define|defun|lambda|fn|if|cond|case|when|unless|let\\*?|letrec|begin|do|and|or|set!|quote|quasiquote|unquote-splicing|unquote|define-record-type|defmacro|defagent|deftool|try|catch|throw|import|module|export|load|delay|force|eval|macroexpand|with-budget|else|prompt|message)(?=[\\s)\\]}]|$)",
      "name": "keyword.control.sema"
    },
    "operator": {
      "match": "(?<=[\\s(\\[{])(?:\\+|\\*|/|>=|<=|>(?!=)|<(?!=)|=|-)(?=[\\s)\\]}]|$)",
      "name": "keyword.operator.arithmetic.sema"
    },
    "threading-macro": {
      "match": "(?<=[\\s(\\[{])(?:->>?|as->)(?=[\\s)\\]}]|$)",
      "name": "keyword.operator.threading.sema"
    },
    "builtin": {
      "patterns": [
        {
          "comment": "Higher-order and core functions",
          "match": "(?<=[\\s(\\[{])(?:map|filter|foldl|foldr|reduce|for-each|apply|gensym|not|error)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "List functions",
          "match": "(?<=[\\s(\\[{])(?:list|cons|car|cdr|first|rest|nth|append|reverse|length|null\\?|list\\?|member|vector|sort|sort-by|take|drop|zip|flatten|range|make-list|flat-map|take-while|drop-while|every|any|partition|last|iota)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "Map functions",
          "match": "(?<=[\\s(\\[{])(?:hash-map|get|assoc|dissoc|merge|keys|vals|contains\\?|count|empty\\?)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "String functions",
          "match": "(?<=[\\s(\\[{])(?:string-append|string/join|string/split|string/trim|string/upper|string/lower|string/replace|string/contains\\?|string/starts-with\\?|string/ends-with\\?|string/capitalize|string/empty\\?|string/index-of|string/reverse|string/repeat|string/pad-left|string/pad-right|str|substring|string-length|string-ref)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "IO and display",
          "match": "(?<=[\\s(\\[{])(?:display|print|println|newline|format|read|read-line|read-many)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "Type predicates",
          "match": "(?<=[\\s(\\[{])(?:number\\?|string\\?|symbol\\?|pair\\?|boolean\\?|procedure\\?|integer\\?|float\\?|keyword\\?|nil\\?|fn\\?|map\\?|record\\?|equal\\?|eq\\?|zero\\?|positive\\?|negative\\?|even\\?|odd\\?|type)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "Type conversions",
          "match": "(?<=[\\s(\\[{])(?:string->number|number->string|string->symbol|symbol->string|string->keyword|keyword->string)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "Math functions",
          "match": "(?<=[\\s(\\[{])(?:abs|min|max|round|floor|ceiling|sqrt|expt|pow|log|sin|cos|ceil|int|float|truncate|mod|modulo|math/remainder|math/gcd|math/lcm|math/pow|math/tan|math/random|math/random-int|math/clamp|math/sign|math/exp|math/log10|math/log2)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "File functions",
          "match": "(?<=[\\s(\\[{])(?:file/read|file/write|file/exists\\?|file/delete|file/list|file/append|file/rename|file/mkdir|file/info|file/read-lines|file/write-lines|file/is-directory\\?|file/is-file\\?|file/copy)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "JSON functions",
          "match": "(?<=[\\s(\\[{])(?:json/decode|json/encode)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "HTTP functions",
          "match": "(?<=[\\s(\\[{])(?:http/get|http/post|http/put|http/delete|http/request)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "Regex functions",
          "match": "(?<=[\\s(\\[{])(?:regex/match\\?|regex/match|regex/find-all|regex/replace|regex/replace-all|regex/split)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "Crypto and encoding functions",
          "match": "(?<=[\\s(\\[{])(?:uuid/v4|base64/encode|base64/decode|hash/md5|hash/sha256|hash/hmac-sha256)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "DateTime functions",
          "match": "(?<=[\\s(\\[{])(?:time/now|time/format|time/parse|time/date-parts|time/add|time/diff)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "CSV functions",
          "match": "(?<=[\\s(\\[{])(?:csv/parse|csv/parse-maps|csv/encode)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "Bitwise functions",
          "match": "(?<=[\\s(\\[{])(?:bit/and|bit/or|bit/xor|bit/not|bit/shift-left|bit/shift-right)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "System functions",
          "match": "(?<=[\\s(\\[{])(?:env|shell|exit|time-ms|sleep|sys/args|sys/cwd|sys/platform|sys/set-env|sys/env-all)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        },
        {
          "comment": "LLM functions",
          "match": "(?<=[\\s(\\[{])(?:conversation/new|conversation/say|conversation/messages|conversation/last-reply|conversation/fork|llm/complete|llm/chat|llm/stream|llm/send|llm/extract|llm/classify|llm/batch|llm/pmap|llm/embed|llm/auto-configure|llm/configure|llm/set-budget|llm/budget-remaining|llm/define-provider|llm/last-usage|llm/session-usage|llm/similarity|llm/clear-budget|prompt/append|prompt/messages|prompt/set-system|message/role|message/content|agent/run)(?=[\\s)\\]}]|$)",
          "name": "support.function.sema"
        }
      ]
    },
    "quoted-expression": {
      "patterns": [
        {
          "name": "keyword.operator.quote.sema",
          "match": "(?<=[\\s(\\[{])'|^'"
        },
        {
          "name": "keyword.operator.quasiquote.sema",
          "match": "(?<=[\\s(\\[{])`|^`"
        },
        {
          "name": "keyword.operator.unquote-splicing.sema",
          "match": "(?<=[\\s(\\[{]),@|^,@"
        },
        {
          "name": "keyword.operator.unquote.sema",
          "match": "(?<=[\\s(\\[{]),|^,"
        }
      ]
    },
    "paren": {
      "patterns": [
        {
          "match": "[()\\[\\]{}]",
          "name": "punctuation.bracket.sema"
        }
      ]
    }
  }
}
