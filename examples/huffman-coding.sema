;; huffman-coding.sema — Huffman coding: build tree, encode, decode
;; Demonstrates: trees as lists, sorting, recursion, maps, string ops

(println "=== Huffman Coding ===\n")

(define message "she sells sea shells by the sea shore")
(println (format "Message: \"~a\"" message))
(println (format "Length:  ~a characters\n" (string-length message)))

;; --- Character frequency analysis ---
(define (char-frequencies s)
  (foldl
    (fn (acc ch)
      (map/update acc (char->string ch) (fn (v) (if (nil? v) 1 (+ v 1)))))
    {}
    (string/chars s)))

(define freqs (char-frequencies message))

;; --- Build Huffman tree ---
;; Leaf: (list :leaf char freq)
;; Branch: (list :branch left right freq)

(define (make-leaf ch freq) (list :leaf ch freq))
(define (make-branch left right)
  (list :branch left right (+ (node-freq left) (node-freq right))))

(define (node-freq node) (nth node (- (length node) 1)))
(define (leaf? node) (eq? (first node) :leaf))

;; Build initial leaf nodes sorted by frequency
(define (build-leaves freqs)
  (sort
    (map (fn (entry) (make-leaf (first entry) (nth entry 1)))
         (map/entries freqs))
    (fn (a b) (- (node-freq a) (node-freq b)))))

;; Insert node into sorted queue
(define (insert-sorted queue node)
  (if (null? queue)
    (list node)
    (if (<= (node-freq node) (node-freq (first queue)))
      (cons node queue)
      (cons (first queue) (insert-sorted (rest queue) node)))))

;; Build tree by repeatedly combining two lowest-frequency nodes
(define (build-tree queue)
  (if (<= (length queue) 1)
    (first queue)
    (let* ((left (first queue))
           (right (nth queue 1))
           (remaining (drop 2 queue))
           (branch (make-branch left right)))
      (build-tree (insert-sorted remaining branch)))))

(define tree (build-tree (build-leaves freqs)))

;; --- Generate code table from tree ---
(define (generate-codes node prefix)
  (if (leaf? node)
    (list (list (nth node 1) prefix))
    (append
      (generate-codes (nth node 1) (string-append prefix "0"))
      (generate-codes (nth node 2) (string-append prefix "1")))))

(define codes (generate-codes tree ""))
(define code-map
  (foldl (fn (acc entry) (assoc acc (first entry) (nth entry 1)))
         {} codes))

;; --- Display code table ---
(println "=== Code Table ===\n")

(define sorted-codes
  (sort codes (fn (a b) (- (string-length (nth a 1)) (string-length (nth b 1))))))

(for-each
  (fn (entry)
    (let* ((ch (first entry))
           (code (nth entry 1))
           (freq (get freqs ch))
           (display-ch (if (= ch " ") "SPC" (format "'~a'" ch))))
      (println (format "  ~a  ~a  (freq: ~a)"
        (string/pad-right display-ch 5)
        (string/pad-right code 12)
        freq))))
  sorted-codes)

;; --- Encode message ---
(define (encode msg code-map)
  (let ((chars (string/chars msg)))
    (string/join
      (map (fn (ch) (get code-map (char->string ch))) chars)
      "")))

(define encoded (encode message code-map))

(println "\n=== Encoded ===\n")
;; Print in chunks of 60 for readability
(define (print-chunks s n)
  (if (<= (string-length s) 0)
    nil
    (let ((chunk (substring s 0 (min n (string-length s))))
          (remaining (substring s (min n (string-length s)))))
      (println (format "  ~a" chunk))
      (print-chunks remaining n))))

(print-chunks encoded 60)

;; --- Decode message ---
(define (decode bits tree)
  (let loop ((bits (string/chars bits)) (node tree) (result ""))
    (if (null? bits)
      (if (leaf? node)
        (string-append result (nth node 1))
        result)
      (let ((next-node
              (if (= (char->string (first bits)) "0")
                (nth node 1)
                (nth node 2))))
        (if (leaf? next-node)
          (loop (rest bits) tree (string-append result (nth next-node 1)))
          (loop (rest bits) next-node result))))))

(define decoded (decode encoded tree))

(println "\n=== Decoded ===\n")
(println (format "  \"~a\"" decoded))

;; --- Statistics ---
(println "\n=== Compression Stats ===\n")

(define original-bits (* (string-length message) 8))
(define encoded-bits (string-length encoded))
(define unique-chars (length (keys freqs)))

(println (format "  Unique characters: ~a" unique-chars))
(println (format "  Original (8-bit):  ~a bits" original-bits))
(println (format "  Huffman encoded:   ~a bits" encoded-bits))
(println (format "  Compression ratio: ~a%"
  (round (* 100 (/ (float encoded-bits) original-bits)))))
(println (format "  Space saved:       ~a%"
  (round (* 100 (- 1.0 (/ (float encoded-bits) original-bits))))))

;; --- Verify roundtrip ---
(println (format "\n  Roundtrip OK: ~a" (if (= message decoded) "YES ✓" "NO ✗")))

(println "\nDone!")
