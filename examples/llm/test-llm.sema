;; test-llm.sema â€” Test LLM features with real API calls
;; Requires ANTHROPIC_API_KEY environment variable

(llm/auto-configure)

;; 1. Simple completion
(println "=== Test 1: llm/complete ===")
(define result (llm/complete "Reply with exactly: HELLO" {:max-tokens 20}))
(println result)
(println (llm/last-usage))

;; 2. Chat with messages
(println "\n=== Test 2: llm/chat ===")
(define reply
  (llm/chat
    [(message
       :system
       "Reply with exactly the word YES")
     (message
       :user
       "Do you understand?")]
    {:max-tokens 10}))
(println reply)

;; 3. Prompt as data
(println "\n=== Test 3: Prompt as data ===")
(define p
  (prompt
    (system "You are a helpful math tutor. Reply with ONLY the number.")
    (user "What is 7 * 8?")))
(define answer (llm/send p {:max-tokens 10}))
(println answer)

;; 4. Structured extraction
(println "\n=== Test 4: llm/extract ===")
(define data
  (llm/extract
    {:city {:type :string}
     :temperature {:type :number}}
    "It's currently 72 degrees in San Francisco"))
(println data)
(println (format "City: ~a, Temp: ~a" (get data :city) (get data :temperature)))

;; 5. Classification
(println "\n=== Test 5: llm/classify ===")
(define sentiment
  (llm/classify [:positive :negative :neutral] "I absolutely love this!"))
(println sentiment)

;; 6. Conversation
(println "\n=== Test 6: Conversation ===")
(define conv (conversation/new {}))
(define conv (conversation/say conv "Remember the number 42"))
(println (format "Reply 1: ~a" (conversation/last-reply conv)))
(define conv (conversation/say conv "What number did I ask you to remember?"))
(println (format "Reply 2: ~a" (conversation/last-reply conv)))

;; 7. Tool use
(println "\n=== Test 7: Tool use ===")
(deftool calculator
  "Perform arithmetic calculations"
  {:expression {:type :string :description "A math expression like '2 + 3'"}}
  (lambda (expr)
    ;; Simple eval: parse "a op b" and compute
    (let ((parts (string/split expr " ")))
      (if (= (length parts) 3)
        (let ((a (string->number (nth parts 0)))
              (op (nth parts 1))
              (b (string->number (nth parts 2))))
          (cond
            ((= op "+") (number->string (+ a b)))
            ((= op "-") (number->string (- a b)))
            ((= op "*") (number->string (* a b)))
            ((= op "/") (number->string (/ a b)))
            (else "unknown operator")))
        expr))))

(define tool-result
  (llm/chat
    [(message
       :system
       "You are a helpful assistant. Use the calculator tool to answer math questions. After getting the result, tell the user.")
     (message
       :user
       "What is 137 * 42?")]
    {:tools [calculator]
     :max-tokens 200}))
(println tool-result)

;; 8. Session usage
(println "\n=== Session Usage ===")
(println (llm/session-usage))

(println "\nAll tests complete!")
