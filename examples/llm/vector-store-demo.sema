;; vector-store-demo.sema — Semantic search with embeddings & vector store
;; Requires: ANTHROPIC_API_KEY or OPENAI_API_KEY environment variable
;; Usage: cargo run -- examples/llm/vector-store-demo.sema
;;
;; Demonstrates: embedding generation, vector store CRUD,
;;               similarity search, and disk persistence.

(llm/auto-configure)
;; Override embedding provider (optional — auto-configure picks one automatically)
;; (llm/configure-embeddings :openai {:model "text-embedding-3-small"})

;; 1. Create a store and add documents
(vector-store/create "knowledge")

(define docs
  '(("lisp" "Lisp is a family of programming languages with a long history")
    ("rust" "Rust is a systems programming language focused on safety")
    ("cooking"
      "Italian cooking relies on fresh ingredients and simple techniques")
    ("ml" "Machine learning uses statistical methods to find patterns in data")
    ("gardening" "Container gardening works well for small urban spaces")))

(for-each
  (lambda (doc)
    (define id (car doc))
    (define text (car (cdr doc)))
    (vector-store/add "knowledge" id (llm/embed text) {:text text}))
  docs)

(println (format "Added ~a documents to vector store\n" (length docs)))

;; 2. Similarity search
(define queries '("writing code" "growing plants" "neural networks"))

(for-each
  (lambda (q)
    (println (format "Query: \"~a\"" q))
    (define results (vector-store/search "knowledge" (llm/embed q) 2))
    (for-each
      (lambda (r)
        (println (format "  ~a (score: ~a)" (:id r) (:score r))))
      results)
    (println ""))
  queries)

;; 3. Persistence — save and reload
(define path "/tmp/sema-knowledge.json")
(vector-store/save "knowledge" path)
(println (format "Saved store to ~a" path))

(vector-store/open "reloaded" path)
(println
  (format "Reloaded store with ~a documents" (vector-store/count "reloaded")))

;; Verify search still works after reload
(define hits (vector-store/search "reloaded" (llm/embed "programming") 1))
(println (format "Top hit after reload: ~a" (:id (car hits))))

;; Cleanup
(file/delete path)

(println "\n=== Session Usage ===")
(println (llm/session-usage))
