;; ask.sema â€” AI Chat CLI
;;
;; Usage:
;;   sema examples/ai-tools/ask.sema -- "What is a monad?"
;;   echo "explain monads" | sema examples/ai-tools/ask.sema
;;   sema examples/ai-tools/ask.sema                          (interactive mode)

(define provider (llm/auto-configure))
(when (nil? provider)
  (io/println-error "Error: Set ANTHROPIC_API_KEY or OPENAI_API_KEY")
  (exit 1))

;; Parse script args (everything after --)
(define (script-args)
  (let loop ((args (sys/args)) (found #f))
    (cond
      ((null? args)         '())
      (found                (cons (car args) (loop (cdr args) #t)))
      ((= (car args) "--")  (loop (cdr args) #t))
      (else                 (loop (cdr args) #f)))))

(define args (script-args))

(define system-prompt "You are a helpful assistant. Be concise and direct.")

(cond
  ;; Mode 1: Question from args
  ((not (null? args))
    (llm/stream
      (prompt
        (system system-prompt)
        (user (string/join args " ")))
      {:max-tokens 4096})
    (newline))

  ;; Mode 2: Piped input
  ((not (sys/interactive?)) (define input (io/read-stdin))
    (llm/stream
      (prompt
        (system system-prompt)
        (user input))
      {:max-tokens 4096})
    (newline))

  ;; Mode 3: Interactive REPL with conversation memory
  (else (io/println-error "AI Chat (type 'quit' to exit)")
    (io/println-error "")
    (define conv (conversation/new {}))
    (let loop ()
      (io/print-error "> ")
      (define input (io/read-line))
      (when
        (and (not (= input "quit"))
          (not (= input "exit"))
          (not (= input "")))
        (set! conv (conversation/say conv input {:system system-prompt}))
        (println (conversation/last-reply conv))
        (println "")
        (loop)))))
