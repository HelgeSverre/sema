# Sync editors/tree-sitter-sema/ to the read-only mirror at
# github.com/helgesverre/tree-sitter-sema.
#
# Setup:
#   1. Generate an SSH key pair:  ssh-keygen -t ed25519 -f tree-sitter-sema-deploy-key -N ""
#   2. Add the PUBLIC key as a deploy key (with write access) in
#      github.com/helgesverre/tree-sitter-sema → Settings → Deploy keys
#   3. Add the PRIVATE key as a secret named TREE_SITTER_SEMA_DEPLOY_KEY in
#      github.com/helgesverre/sema → Settings → Secrets → Actions
#
# Tag mirroring:
#   Push a tag matching `tree-sitter-sema-v*` (e.g. tree-sitter-sema-v0.1.0)
#   and it will be synced to the mirror as `v0.1.0`.

name: Sync tree-sitter-sema

on:
  workflow_dispatch:
  push:
    branches: [main]
    tags:
      - 'tree-sitter-sema-v*'
    paths:
      - 'editors/tree-sitter-sema/**'

jobs:
  split:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TREE_SITTER_SEMA_DEPLOY_KEY }}

      - name: Split and push
        run: |
          SHA=$(git subtree split --prefix=editors/tree-sitter-sema)

          git remote add mirror git@github.com:helgesverre/tree-sitter-sema.git || true
          git push mirror "$SHA:refs/heads/main" --force

      - name: Sync tag
        if: startsWith(github.ref, 'refs/tags/tree-sitter-sema-v')
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          MIRROR_TAG="${TAG#tree-sitter-sema-}"

          SHA=$(git subtree split --prefix=editors/tree-sitter-sema)

          git tag "$MIRROR_TAG" "$SHA"
          git push mirror "$MIRROR_TAG" --force
