<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sema VFS Explorer</title>
<meta name="description" content="Explore Sema's in-memory Virtual File System ‚Äî persistent across evals, powered by WebAssembly.">
<meta name="theme-color" content="#c8a855">
<link rel="icon" type="image/svg+xml" href="../favicon.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant:wght@300;400;500&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="loading-title">Sema</div>
  <div class="loading-dots"><span></span><span></span><span></span></div>
</div>

<header>
  <span class="logo">Sema VFS Explorer</span>
  <div class="header-right">
    <span class="version-badge" id="version">loading‚Ä¶</span>
    <a href="https://sema-lang.com/docs/" class="header-link">Docs</a>
    <a href="https://github.com/HelgeSverre/sema" class="header-link">GitHub</a>
  </div>
</header>

<main>
  <div class="file-tree-pane">
    <div class="pane-header">
      <span class="pane-title">File Explorer</span>
      <select id="backend-select" class="backend-select" data-testid="backend-select">
        <option value="memory">In-Memory</option>
        <option value="local">LocalStorage</option>
        <option value="session">SessionStorage</option>
        <option value="indexeddb">IndexedDB</option>
      </select>
    </div>
    <div class="file-tree" id="file-tree" data-testid="file-tree"></div>
  </div>

  <div class="pane editor-pane">
    <div class="pane-header">
      <span class="pane-title">Source</span>
      <div class="header-actions">
        <button class="btn-clear" id="clear-vfs-btn" data-testid="clear-vfs-btn">Clear VFS</button>
        <button class="btn-run" id="run-btn" data-testid="run-btn" disabled>
          Run<span class="shortcut">‚åò‚Üµ</span>
        </button>
      </div>
    </div>
    <div class="editor-wrap">
      <textarea id="editor" data-testid="editor" spellcheck="false">;; === TinySite: A Mini Static Site Generator ===
;; Demonstrates all VFS operations in one script.
;; The file explorer on the left updates after each run.

;; Helper to show yes/no for booleans
(define (yesno b) (if b "yes" "no"))

;; --- 1. Scaffold project directories ---
(println "üìÅ Scaffolding project...")
(file/mkdir "site")
(file/mkdir "site/src")
(file/mkdir "site/dist")
(file/mkdir "site/assets")
(println "   Created site/, site/src/, site/dist/, site/assets/")

;; --- 2. Write source files ---
(println "\nüìù Writing source files...")

(file/write "site/src/index.md"
  "# Welcome to TinySite\n\nA tiny static site built entirely in the VFS.\n\n- Fast\n- In-memory\n- Persistent until refresh\n")

(file/write "site/src/about.md"
  "# About\n\nThis site was generated by Sema code running in WebAssembly.\nAll files live in an in-memory virtual filesystem.\n")

(file/write "site/src/draft.md"
  "# DRAFT: Secret Page\n\nThis will be deleted before we ship!\n")

(file/write "site/assets/style.css"
  "body { font-family: system-ui; max-width: 640px; margin: 2rem auto; }\nh1 { color: #c8a855; }\na { color: #7aacb8; }\n")

(println "   Wrote 3 source files + 1 stylesheet")

;; --- 3. Check existence and types ---
(println "\nüîç Checking paths...")
(println (format "   site/src exists?        ~a" (yesno (file/exists? "site/src"))))
(println (format "   site/src is-directory?   ~a" (yesno (file/is-directory? "site/src"))))
(println (format "   site/src is-file?        ~a" (yesno (file/is-file? "site/src"))))
(println (format "   site/src/index.md file?  ~a" (yesno (file/is-file? "site/src/index.md"))))
(println (format "   site/src/nope.md exists? ~a" (yesno (file/exists? "site/src/nope.md"))))

;; --- 4. Build HTML pages ---
(println "\nüî® Building HTML pages...")

(define (build-page src-path out-path title)
  (let ((content (file/read src-path)))
    (file/write out-path
      (string-append
        "<!doctype html>\n<html>\n<head>\n"
        "  <title>" title "</title>\n"
        "  <link rel=\"stylesheet\" href=\"style.css\">\n"
        "</head>\n<body>\n"
        "  <nav><a href=\"index.html\">Home</a> | <a href=\"about.html\">About</a></nav>\n"
        "  <pre>" content "</pre>\n"
        "</body>\n</html>\n"))
    (println (format "   Built ~a -> ~a" src-path out-path))))

(build-page "site/src/index.md" "site/dist/index.html" "TinySite")
(build-page "site/src/about.md" "site/dist/about.html" "About ‚Äî TinySite")

;; Copy stylesheet to dist
(file/write "site/dist/style.css" (file/read "site/assets/style.css"))
(println "   Copied style.css to dist/")

;; --- 5. Append to a build log ---
(println "\nüìã Writing build log (append demo)...")
(file/write "site/build.log" "=== Build Log ===\n")
(file/append "site/build.log" "- scaffolded directories\n")
(file/append "site/build.log" "- wrote source files\n")
(file/append "site/build.log" "- built HTML pages\n")
(println (file/read "site/build.log"))

;; --- 6. Rename a file ---
(println "‚úèÔ∏è  Renaming about.md -> about-us.md...")
(file/rename "site/src/about.md" "site/src/about-us.md")
(println (format "   Old exists? ~a" (yesno (file/exists? "site/src/about.md"))))
(println (format "   New exists? ~a" (yesno (file/exists? "site/src/about-us.md"))))

;; --- 7. Delete the draft ---
(println "\nüóëÔ∏è  Deleting draft...")
(file/delete "site/src/draft.md")
(println (format "   draft.md exists? ~a" (yesno (file/exists? "site/src/draft.md"))))

;; --- 8. List directory contents ---
(println "\nüìÇ Final directory listings:")
(for-each
  (lambda (dir)
    (let ((items (file/list dir)))
      (println (format "\n   ~a/ (~a items)" dir (length items)))
      (for-each (lambda (f) (println (format "     ~a" f))) items)))
  (list "site" "site/src" "site/dist" "site/assets"))

(file/append "site/build.log" "- renamed about page\n")
(file/append "site/build.log" "- deleted draft\n")
(file/append "site/build.log" "- build complete!\n")

(println "\n‚úÖ Done! Click files in the explorer to view them.")
(println "   Re-run to see persistence ‚Äî files survive across evals.")</textarea>
    </div>
  </div>

  <div class="right-column">
    <div class="pane output-pane">
      <div class="pane-header">
        <span class="pane-title">Output</span>
        <button class="btn-clear" id="clear-output-btn">Clear</button>
      </div>
      <div id="output" data-testid="output">
        <div class="output-welcome">Initializing Sema interpreter‚Ä¶</div>
      </div>
    </div>

    <div class="pane file-viewer-pane">
      <div class="pane-header">
        <span class="pane-title" id="viewer-title">File Viewer</span>
      </div>
      <pre id="file-viewer" data-testid="file-viewer" class="file-viewer-content"><span class="viewer-placeholder">Click a file in the explorer to view its contents.</span></pre>
    </div>
  </div>
</main>

<div class="status-bar" data-testid="status">
  <span class="status-text status-loading" id="status-text">Loading WASM module‚Ä¶</span>
  <span class="status-text" id="backend-info" data-testid="backend-info"></span>
  <span class="status-text" id="vfs-stats" data-testid="vfs-stats"></span>
</div>

<script type="module" src="./app.js"></script>
</body>
</html>
