;; explain.sema â€” AI Code Explainer
;;
;; Usage:
;;   sema examples/ai-tools/explain.sema -- path/to/file.rs
;;   cat file.py | sema examples/ai-tools/explain.sema
;;   sema examples/ai-tools/explain.sema -- file.rs --brief

(define provider (llm/auto-configure))
(when (nil? provider)
  (println-error "Error: Set ANTHROPIC_API_KEY or OPENAI_API_KEY")
  (exit 1))

;; Parse script args
(define (script-args)
  (let loop ((args (sys/args)) (found #f))
    (cond
      ((null? args) '())
      (found (cons (car args) (loop (cdr args) #t)))
      ((= (car args) "--") (loop (cdr args) #t))
      (else (loop (cdr args) #f)))))

(define args (script-args))

;; Check for --brief flag
(define brief? (any (lambda (a) (= a "--brief")) args))
(define file-args (filter (lambda (a) (not (string/starts-with? a "--"))) args))

;; Get the code to explain
(define code
  (cond
    ((not (null? file-args))
     (define path (car file-args))
     (unless (file/exists? path)
       (println-error (format "File not found: ~a" path))
       (exit 1))
     (println-error (format "Explaining ~a..." path))
     (file/read path))
    ((not (sys/interactive?))
     (println-error "Explaining piped input...")
     (read-stdin))
    (else
     (println-error "Usage: sema explain.sema -- <file>")
     (println-error "       cat file | sema explain.sema")
     (exit 1))))

(define system-msg
  (if brief?
    "You are a code explainer. Give a brief, high-level explanation of the code in 2-3 sentences. Focus on what it does, not how."
    "You are a code explainer. Explain the code clearly and concisely. Cover: what it does, key functions/structures, and any notable patterns or algorithms. Use markdown formatting."))

(llm/stream
  (prompt
    (system system-msg)
    (user (string-append "Explain this code:\n\n```\n" code "\n```")))
  {:max-tokens 4096})
(newline)
